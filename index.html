<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvoZ</title>

<link rel="stylesheet" href="style.css">

<style>
    body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
        background: #000;
        color: #fff;
    }

    #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: rgba(0,0,0,0.4);
        padding: 10px;
        border-radius: 8px;
        pointer-events: none;
        display: none;
    }

    #stats p {
        margin: 5px 0;
    }

    #skills {
        margin-top: 10px;
    }

    #skillButtons button {
        display: block;
        margin: 3px 0;
        padding: 4px 8px;
        background: #111;
        color: #0f0;
        border: 1px solid #0f0;
        border-radius: 4px;
        cursor: pointer;
        pointer-events: auto;
    }

    #skillButtons button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    #leaderboard {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        width: 250px;
        background: rgba(0,0,0,0.4);
        padding: 10px;
        border-radius: 8px;
        max-height: 80vh;
        overflow-y: auto;
        display: none;
    }

    #leaderboard h3 {
        margin-top: 0;
        text-align: center;
        color: #0ff;
    }

    #leaderboard div {
        margin: 3px 0;
        font-size: 14px;
        border-bottom: 1px dotted #0ff;
        padding-bottom: 2px;
    }

    canvas {
        display: block;
    }

    /* ===== Music Button ===== */
    #musicToggle {
        margin-top: 8px;
        padding: 4px 8px;
        background: #111;
        color: #0ff;
        border: 1px solid #0ff;
        border-radius: 4px;
        cursor: pointer;
        pointer-events: auto;
        font-size: 12px;
    }

    /* ===== Achievements Container ===== */
    #achievements-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        pointer-events: none;
    }

    .achievement-popup {
        background: linear-gradient(135deg,#00ffcc,#00aa88);
        color: #00131f;
        padding: 12px 28px;
        margin-top: 10px;
        font-weight: bold;
        font-family: Arial, sans-serif;
        font-size: 20px;
        text-shadow: 0 0 10px #00ffcc, 0 0 30px #00ffcc;
        border-radius: 6px;
        box-shadow: 0 0 10px #00ffcc, 0 0 30px #00ffcc;
        opacity: 0;
        transform: translateY(-50px);
        animation: achievementShow 0.6s ease forwards, achievementHide 0.6s ease 2.4s forwards;
    }

    @keyframes achievementShow {
        to { opacity: 1; transform: translateY(0) scale(1.05); }
    }

    @keyframes achievementHide {
        to { opacity: 0; transform: translateY(-50px) scale(0.9); }
    }
</style>
</head>

<body>

<!-- ================= UI ================= -->
<div id="ui">
    <div id="stats">
        <p>Size: <span id="size">10</span></p>
        <p>XP: <span id="xp">0</span></p>
        <p>Level: <span id="level">1</span></p>
    </div>

    <div id="skills">
        <p>Skills:</p>
        <div id="skillButtons"></div>
    </div>

    <!-- Music Toggle -->
    <button id="musicToggle">ðŸ”Š Music On</button>
</div>

<!-- ================= Leaderboard ================= -->
<div id="leaderboard">
    <h3>Leaderboard</h3>
</div>

<!-- ================= Canvas ================= -->
<canvas id="gameCanvas"></canvas>

<!-- ================= Intro ================= -->
<script src="intro.js"></script>

<!-- ================= Game + Music Loader ================= -->
<script>
let bgMusic;
let musicEnabled = true;
let gameLoaded = false;

function startMusic() {
    if (!bgMusic) {
        bgMusic = new Audio("sounds/Anything.mp3");
        bgMusic.loop = true;
        bgMusic.volume = 0.7;
        bgMusic.play().catch(() => {
            console.log("Autoplay blocked until user interaction.");
        });
    }
}

function unlockAudio() {
    startMusic();
    document.removeEventListener("click", unlockAudio);
    document.removeEventListener("keydown", unlockAudio);
}
document.addEventListener("click", unlockAudio);
document.addEventListener("keydown", unlockAudio);

document.addEventListener("evoz-start-game", () => {
    document.getElementById("ui").style.display = "block";
    document.getElementById("leaderboard").style.display = "block";
    startMusic();

    if (!gameLoaded) {
        const script = document.createElement("script");
        script.type = "module";
        script.src = "game.js";
        document.body.appendChild(script);
        gameLoaded = true;
    }
});

// Music toggle button
const btn = document.getElementById("musicToggle");
btn.onclick = () => {
    if (!bgMusic) {
        startMusic();
        musicEnabled = true;
        btn.textContent = "ðŸ”Š Music On";
    } else {
        musicEnabled = !musicEnabled;
        if (musicEnabled) {
            bgMusic.play();
            btn.textContent = "ðŸ”Š Music On";
        } else {
            bgMusic.pause();
            btn.textContent = "ðŸ”‡ Music Off";
        }
    }
};
</script>

<!-- ================= Achievements System ================= -->
<script>
(function() {
    if (window.EvoZAchievements) return;
    window.EvoZAchievements = true;

    document.addEventListener("evoz-start-game", () => {

        const achievements = [
            { id: 'first_kill', name: 'First Blood', desc: 'Kill 1 enemy', condition: s => s.kills >= 1, unlocked: false },
            { id: 'level10', name: 'Rising Star', desc: 'Reach Level 10', condition: s => s.level >= 10, unlocked: false },
            { id: 'xp100', name: 'XP Collector', desc: 'Gain 100 XP', condition: s => s.totalXP >= 100, unlocked: false },
            { id: 'xp1000', name: 'XP Collector 2', desc: 'Gain 1000 XP', condition: s => s.totalXP >= 1000, unlocked: false },
            { id: 'xp10000', name: 'XP Collector 3', desc: 'Gain 10000 XP', condition: s => s.totalXP >= 10000, unlocked: false },
            { id: 'kill50', name: 'Slayer', desc: 'Kill 50 enemies', condition: s => s.kills >= 50, unlocked: false },
            { id: 'level50', name: 'Champion', desc: 'Reach Level 50', condition: s => s.level >= 50, unlocked: false },
            { id: 'level50', name: 'King', desc: 'Reach Level 100', condition: s => s.level >= 100, unlocked: false }
        ];

        const stats = { kills: 0, combo: 0, maxCombo: 0, totalXP: 0, level: 1 };

        // Create container
        const container = document.createElement('div');
        container.id = 'achievements-container';
        document.body.appendChild(container);

        // Show popup
        function showAchievementPopup(name, desc) {
            const div = document.createElement('div');
            div.className = 'achievement-popup';
            div.innerHTML = `<strong>${name}</strong>: ${desc}`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function checkAchievements() {
            achievements.forEach(a => {
                if (!a.unlocked && a.condition(stats)) {
                    a.unlocked = true;
                    showAchievementPopup(a.name, a.desc);
                }
            });
        }

        // Wait for game.js to initialize module-scoped player and enemies
        const waitForPlayer = setInterval(() => {
            try {
                if (window.player && window.enemies) {
    clearInterval(waitForPlayer);

    const playerRef = window.player;
    const enemiesRef = window.enemies;

    // Hook XP
    let _xp = playerRef.xp;
    Object.defineProperty(playerRef, 'xp', {
        get() { return _xp; },
        set(val) {
            if (val > _xp) stats.totalXP += val - _xp;
            _xp = val;
            checkAchievements();
        }
    });

    // Wrap enemies.splice to track kills
    const originalSplice = enemiesRef.splice.bind(enemiesRef);
    enemiesRef.splice = function(index, deleteCount, ...items) {
        const removed = enemiesRef.slice(index, index + deleteCount);
        removed.forEach(e => {
            if (e.killedByPlayer) {
                stats.kills++;
                stats.combo++;
                if (stats.combo > stats.maxCombo) stats.maxCombo = stats.combo;
                stats.level = playerRef.level;
                checkAchievements();
            }
        });
        return originalSplice(index, deleteCount, ...items);
    };


                    // Reset combo if no kills for 1s
                    setInterval(() => stats.combo = 0, 1000);

                    window.EvoZAchievementsStats = stats;
                }
            } catch(e) {
                // ignore errors until player/enemies exist
            }
        }, 50);

    });
})();
</script>

</body>
</html>
